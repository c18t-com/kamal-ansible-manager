---
- name: Configure kernel parameters for security hardening
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    sysctl_set: true
    reload: true
  loop:
    # Network Security
    - { name: "net.ipv4.tcp_syncookies", value: "1" }
    - { name: "net.ipv4.tcp_max_syn_backlog", value: "2048" }
    - { name: "net.ipv4.tcp_synack_retries", value: "2" }
    - { name: "net.ipv4.tcp_syn_retries", value: "5" }

    # IP Spoofing Protection
    - { name: "net.ipv4.conf.all.rp_filter", value: "1" }
    - { name: "net.ipv4.conf.default.rp_filter", value: "1" }

    # Ignore ICMP redirects
    - { name: "net.ipv4.conf.all.accept_redirects", value: "0" }
    - { name: "net.ipv4.conf.default.accept_redirects", value: "0" }
    - { name: "net.ipv4.conf.all.secure_redirects", value: "0" }
    - { name: "net.ipv4.conf.default.secure_redirects", value: "0" }
    - { name: "net.ipv6.conf.all.accept_redirects", value: "0" }
    - { name: "net.ipv6.conf.default.accept_redirects", value: "0" }

    # Do not send ICMP redirects
    - { name: "net.ipv4.conf.all.send_redirects", value: "0" }
    - { name: "net.ipv4.conf.default.send_redirects", value: "0" }

    # Disable source packet routing
    - { name: "net.ipv4.conf.all.accept_source_route", value: "0" }
    - { name: "net.ipv4.conf.default.accept_source_route", value: "0" }
    - { name: "net.ipv6.conf.all.accept_source_route", value: "0" }
    - { name: "net.ipv6.conf.default.accept_source_route", value: "0" }

    # Log Martians (packets with impossible addresses)
    - { name: "net.ipv4.conf.all.log_martians", value: "1" }
    - { name: "net.ipv4.conf.default.log_martians", value: "1" }

    # Ignore ICMP ping requests
    - { name: "net.ipv4.icmp_echo_ignore_all", value: "0" }
    - { name: "net.ipv4.icmp_echo_ignore_broadcasts", value: "1" }

    # Ignore bad ICMP errors
    - { name: "net.ipv4.icmp_ignore_bogus_error_responses", value: "1" }

    # Disable IPv6 Router Advertisements
    - { name: "net.ipv6.conf.all.accept_ra", value: "0" }
    - { name: "net.ipv6.conf.default.accept_ra", value: "0" }

    # Enable IPv6 privacy extensions
    - { name: "net.ipv6.conf.all.use_tempaddr", value: "2" }
    - { name: "net.ipv6.conf.default.use_tempaddr", value: "2" }

    # Increase the range of ports
    - { name: "net.ipv4.ip_local_port_range", value: "1024 65535" }

    # Enable TCP Fast Open
    - { name: "net.ipv4.tcp_fastopen", value: "3" }

    # Kernel Security
    # Restrict access to kernel logs
    - { name: "kernel.dmesg_restrict", value: "1" }

    # Restrict access to kernel pointers
    - { name: "kernel.kptr_restrict", value: "2" }

    # Restrict kernel core dumps
    - { name: "kernel.core_uses_pid", value: "1" }

    # Enable ExecShield protection
    - { name: "kernel.exec-shield", value: "1" }

    # Randomize memory space
    - { name: "kernel.randomize_va_space", value: "2" }

    # Restrict ptrace scope
    - { name: "kernel.yama.ptrace_scope", value: "1" }

    # File System Security
    # Protect against hardlink/symlink attacks
    - { name: "fs.protected_hardlinks", value: "1" }
    - { name: "fs.protected_symlinks", value: "1" }

    # Increase file handles
    - { name: "fs.file-max", value: "65535" }
