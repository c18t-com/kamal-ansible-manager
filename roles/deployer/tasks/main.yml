---
- name: Create or update deployer user
  ansible.builtin.user:
    name: deployer
    shell: /bin/bash
    home: /home/deployer
    create_home: true
    groups: docker
    append: true
    password_lock: true

- name: Ensure .bashrc exists
  ansible.builtin.copy:
    src: /etc/skel/.bashrc
    dest: /home/deployer/.bashrc
    owner: deployer
    group: deployer
    mode: '0644'
    remote_src: true
    force: false

- name: Ensure .profile exists
  ansible.builtin.copy:
    src: /etc/skel/.profile
    dest: /home/deployer/.profile
    owner: deployer
    group: deployer
    mode: '0644'
    remote_src: true
    force: false

- name: Ensure home directory ownership
  ansible.builtin.file:
    path: /home/deployer
    owner: deployer
    group: deployer
    state: directory

- name: Check if SSH key already exists
  ansible.builtin.stat:
    path: /home/deployer/.ssh/id_ed25519
  register: ssh_key_check

- name: Generate SSH key pair for deployer
  ansible.builtin.user:
    name: deployer
    generate_ssh_key: true
    ssh_key_type: ed25519
    ssh_key_file: /home/deployer/.ssh/id_ed25519
  when: not ssh_key_check.stat.exists

- name: Set proper permissions on SSH directory
  ansible.builtin.file:
    path: /home/deployer/.ssh
    owner: deployer
    group: deployer
    mode: '0700'
    state: directory

- name: Copy public key to authorized_keys
  ansible.builtin.copy:
    src: /home/deployer/.ssh/id_ed25519.pub
    dest: /home/deployer/.ssh/authorized_keys
    owner: deployer
    group: deployer
    mode: '0600'
    remote_src: true

- name: Fetch private key to local machine
  ansible.builtin.fetch:
    src: /home/deployer/.ssh/id_ed25519
    dest: ./keys/{{ inventory_hostname }}/id_ed25519
    flat: true

- name: Set proper permissions on local private key
  ansible.builtin.file:
    path: ./keys/{{ inventory_hostname }}/id_ed25519
    mode: '0600'
  delegate_to: localhost

- name: Fetch public key to local machine
  ansible.builtin.fetch:
    src: /home/deployer/.ssh/id_ed25519.pub
    dest: ./keys/{{ inventory_hostname }}/id_ed25519.pub
    flat: true